#!/bin/bash

# PARSE ARGUMENTS
POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    -e|--extension)
    EXTENSION="$2"
    shift # past argument
    shift # past value
    ;;
    -s|--searchpath)
    SEARCHPATH="$2"
    shift # past argument
    shift # past value
    ;;
    -l|--lib)
    LIBPATH="$2"
    shift # past argument
    shift # past value
    ;;
    --default)
    DEFAULT=YES
    shift # past argument
    ;;
    *)    # unknown option
    POSITIONAL+=("$1") # save it in an array for later
    shift # past argument
    ;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

EXEC=$2
DIRECTORY=`dirname $0`

echo "running $EXEC on:"
echo "`cat hosts`"
echo "================="

export GAM_LOG_PREFIX=$PWD/logs
export GAM_CARDINALITY=$1
export TASK_COUNT=$(($GAM_CARDINALITY - 1))
export BASE_PAP=6100
export BASE_MEM=6228
export BASE_DMN=6356


for i in `eval echo {0..$TASK_COUNT}`
do
        IDX=$(($i + 1))
        HOST=`sed "${IDX}q;d" hosts`
        export GAM_NODE_$i=$HOST
        export GAM_SVC_PAP_$i=$BASE_PAP
        export GAM_SVC_MEM_$i=$BASE_MEM
        export GAM_SVC_DMN_$i=$BASE_DMN
done

mpirun --machinefile hosts --pernode --tag-output -n $GAM_CARDINALITY $DIRECTORY/fastnode-mpi $EXEC
